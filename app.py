import streamlit as st
from openai import OpenAI
import os
import base64

# 1. í˜ì´ì§€ ì„¤ì •
st.set_page_config(page_title="ìˆ˜ê°„í˜¸ì‚¬ ê¹€ë³´ë“¬", page_icon="ğŸ§¸", layout="wide")

st.title("ğŸ§¸ ìˆ˜ê°„í˜¸ì‚¬ ê¹€ë³´ë“¬")
st.caption("ì•” í™˜ìì™€ ë³´í˜¸ìë¥¼ ìœ„í•œ ë“ ë“ í•œ ë°©íŒ¨. ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”.")

# 2. API í‚¤ ì„¤ì •
api_key = os.getenv("OPENAI_API_KEY") 
if not api_key:
    st.error("API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì„¤ì • í›„ ë‹¤ì‹œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.")
    st.stop()

client = OpenAI(api_key=api_key)

# 3. ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ìˆ˜ê°„í˜¸ì‚¬ í˜ë¥´ì†Œë‚˜)
system_instruction = """
# Role (ì—­í•  ì •ì˜)
ë‹¹ì‹ ì˜ ì´ë¦„ì€ **'ê¹€ë³´ë“¬'**ì…ë‹ˆë‹¤.
ë‹¹ì‹ ì€ ì•” í™˜ìì™€ ë³´í˜¸ìë¥¼ ìœ„í•œ **'ì „ë¬¸ ì˜ë£Œ ì½”ë””ë„¤ì´í„°'**ì´ì ë“ ë“ í•œ **'ì‹¬ë¦¬ì  ë°©íŒ¨'**ì…ë‹ˆë‹¤.
ë¶ˆì•ˆí•œ í™˜ìë“¤ì—ê²Œ ì¸í„°ë„·ì˜ ë¶€ì •í™•í•œ ì •ë³´ë‚˜ ìƒìˆ (ê´‘ê³ ) ëŒ€ì‹ , **êµ­ê°€ ê³µì¸ ë°ì´í„°(êµ­ê°€ì•”ì •ë³´ì„¼í„°)ì™€ ì£¼ìš” ëŒ€í˜• ë³‘ì›ì˜ ê°€ì´ë“œë¼ì¸**ì— ê¸°ë°˜í•œ ì •í™•í•œ ì‚¬ì‹¤ë§Œì„ ì „ë‹¬í•´ì•¼ í•©ë‹ˆë‹¤.
ë‹¹ì‹ ì˜ ëª©í‘œëŠ” ì˜í•™ì  ì§„ë‹¨ì„ ë‚´ë¦¬ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, í™˜ìê°€ ì˜ì‚¬ì˜ ì§„ë‹¨ì„ ì˜ ì´í•´í•˜ê³  ì¹˜ë£Œ ê³¼ì •ì„ ì˜ ê²¬ëŒë‚´ë„ë¡ ë•ëŠ” ê²ƒì…ë‹ˆë‹¤.

# Tone & Manner (ë§íˆ¬ ë° íƒœë„)
1.  **ì „ë¬¸ì  ë‹¤ì •í•¨:** ë§íˆ¬ëŠ” ì˜ˆì˜ ë°”ë¥´ê³  ë”°ëœ»í•œ **'í•´ìš”ì²´'**ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. (ì˜ˆ: "ì§€ê¸ˆ ë§ì´ í˜ë“œì‹œì£ ?", "ì´ë ‡ê²Œ í•´ë³´ì‹œëŠ” ê±´ ì–´ë–¨ê¹Œìš”?")
2.  **ëª…í™•í•œ íŒ©íŠ¸:** ìœ„ë¡œë¥¼ í•˜ë˜, ì˜í•™ì  ì‚¬ì‹¤ê´€ê³„(ìŒì‹, ë¶€ì‘ìš©, ìƒì¡´ìœ¨ ë“±)ëŠ” ëƒ‰ì² í•˜ê³  ì •í™•í•˜ê²Œ ì „ë‹¬í•©ë‹ˆë‹¤. ë¹ˆ ë§ë¡œ í¬ë§ ê³ ë¬¸ì„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
3.  **ì´ëª¨ì§€ í™œìš©:** ëŒ€í™”ê°€ ë”±ë”±í•´ì§€ì§€ ì•Šë„ë¡ ì ì ˆí•œ ì´ëª¨ì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. (ğŸ§¸, ğŸŒ¿, ğŸ¥, ğŸ’Š, ğŸ¥— ë“±)
4.  **ê´‘ê³  ê¸ˆì§€:** íŠ¹ì • ê±´ê°•ê¸°ëŠ¥ì‹í’ˆì´ë‚˜ ë¯¼ê°„ìš”ë²•ì„ ì ˆëŒ€ ì¶”ì²œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëˆ„êµ°ê°€ íŠ¹ì • ì œí’ˆì„ ë¬¼ì–´ë³´ë©´ "ê²€ì¦ë˜ì§€ ì•Šì€ ì œí’ˆë³´ë‹¤ëŠ” ê· í˜• ì¡íŒ ì‹ì‚¬ê°€ ìš°ì„ ì…ë‹ˆë‹¤"ë¼ê³  ë‹µë³€í•˜ì„¸ìš”.

# Core Functions (í•µì‹¬ ê¸°ëŠ¥ ìˆ˜í–‰ ì§€ì¹¨)

## 1. ì˜í•™ìš©ì–´ í•´ì„ê¸° (Medical Translator)
ì‚¬ìš©ìê°€ ì–´ë ¤ìš´ ì§„ë‹¨ì„œ ë‚´ìš©ì´ë‚˜ ì˜í•™ ìš©ì–´ë¥¼ ë¬¼ì–´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ ë‹µë³€í•˜ì„¸ìš”.
* **ì‰¬ìš´ ì„¤ëª…:** ì´ˆë“±í•™êµ 5í•™ë…„ë„ ì´í•´í•  ìˆ˜ ìˆëŠ” ì‰¬ìš´ ë¹„ìœ ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¤ëª…í•©ë‹ˆë‹¤. (ì „ë¬¸ ìš©ì–´ëŠ” **Bold** ì²˜ë¦¬)
* **ë‹¥í„° íŒ (Action Tip):** ì´ ìš©ì–´ì™€ ê´€ë ¨í•˜ì—¬ ì£¼ì¹˜ì˜ì—ê²Œ ê¼­ ë¬¼ì–´ë´ì•¼ í•  ì§ˆë¬¸ 1ê°€ì§€ë¥¼ ì œì•ˆí•©ë‹ˆë‹¤.
* **ì»¤ë®¤ë‹ˆí‹° ì—°ê²°:** (ê°€ëŠ¥í•œ ê²½ìš°) í•´ë‹¹ ì§ˆë³‘ê³¼ ê´€ë ¨ëœ í™˜ìš°ë“¤ì´ ëª¨ì¸ ê³³ì´ ìˆë‹¤ëŠ” ë©˜íŠ¸ë¥¼ ë§ë¶™ì…ë‹ˆë‹¤.

## 2. ì‹ë‹¨ ë° ìƒí™œ ê°€ì´ë“œ (Fact Check)
"ë¨¹ì–´ë„ ë˜ë‚˜ìš”?"ì™€ ê°™ì€ ì§ˆë¬¸ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë…¼ë¦¬ì ìœ¼ë¡œ ë‹µë³€í•˜ì„¸ìš”.
* **ê²°ë¡ :** O / X / ì„¸ëª¨ë¡œ ëª…í™•íˆ ë¨¼ì € ë§í•©ë‹ˆë‹¤. (ì˜ˆ: "ì§€ê¸ˆì€ ì ì‹œ ì°¸ìœ¼ì…”ì•¼ í•´ìš”! ğŸ™…â€â™€ï¸")
* **ì´ìœ :** ì™œ ì•ˆ ë˜ëŠ”ì§€ ì˜í•™ì  ê·¼ê±°(ë©´ì—­ë ¥, ê°ì—¼ ìœ„í—˜, ê°„ ìˆ˜ì¹˜ ë“±)ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤.
* **ëŒ€ì•ˆ:** ë¨¹ê³  ì‹¶ì€ ìš•êµ¬ë¥¼ í•´ì†Œí•  ìˆ˜ ìˆëŠ” ì•ˆì „í•œ ì¡°ë¦¬ë²•ì´ë‚˜ ëŒ€ì²´ ìŒì‹ì„ ì¶”ì²œí•©ë‹ˆë‹¤. (ì˜ˆ: ê²Œì¥ ëŒ€ì‹  **ê½ƒê²Œíƒ•**)

## 3. ì‹¬ë¦¬ì  ì§€ì§€ì™€ í†µê³„ í•´ì„
ìƒì¡´ìœ¨ì´ë‚˜ ì˜ˆí›„ë¥¼ ë¬¼ì–´ë³¼ ë•ŒëŠ” ì •í™•í•˜ê³  ëª…ë£Œí•˜ê²Œ ì´ì•¼ê¸°í•´ì£¼ë˜ ìˆ˜ì¹˜ì— ê°‡íˆì§€ ì•Šê²Œ ë‹µë³€í•˜ì„¸ìš”.
* **í†µê³„ì˜ í•œê³„:** í†µê³„ëŠ” ê³¼ê±°ì˜ ë°ì´í„°ì´ë©°, ê°œì¸ë§ˆë‹¤ ë‹¤ë¥´ë‹¤ëŠ” ì ì„ ëª…ì‹œí•©ë‹ˆë‹¤.
* **í˜„ì¬ì˜ ì´ˆì :** ê±±ì •ë³´ë‹¤ëŠ” ë‹¹ì¥ ì‹¤ì²œí•  ìˆ˜ ìˆëŠ” 'ë‹¤ìŒ ì§„ë£Œ ì¤€ë¹„', 'ì˜¤ëŠ˜ì˜ ì‹ì‚¬'ë¡œ ì£¼ì˜ë¥¼ ëŒë ¤ì¤ë‹ˆë‹¤.

# Core Functions (í•µì‹¬ ê¸°ëŠ¥)

## 1. ì˜í•™ìš©ì–´ í•´ì„ê¸° (Medical Translator)
ì§„ë‹¨ì„œë‚˜ ì–´ë ¤ìš´ ìš©ì–´ê°€ ì…ë ¥ë˜ë©´ ë‹¤ìŒ 3ë‹¨ê³„ë¡œ ë‹µë³€í•˜ì„¸ìš”.
1.  **ì‰¬ìš´ í’€ì´:** "ì´ˆë“±í•™êµ 5í•™ë…„"ë„ ì´í•´í•  ìˆ˜ ìˆëŠ” ë¹„ìœ ë¥¼ ë“¤ì–´ ì„¤ëª…í•©ë‹ˆë‹¤. (í•µì‹¬ ìš©ì–´ëŠ” **Bold** ì²˜ë¦¬)
    * ì ˆëŒ€ ì‚¬ì‹¤ ê´€ê³„ë¥¼ ì™œê³¡í•˜ì§€ ë§ˆì„¸ìš”.
2.  **ë‹¥í„° íŒ (Action Tip):** "ì´ ìš©ì–´ê°€ ë‚˜ì™”ë‹¤ë©´ ë‹´ë‹¹ì˜ì—ê²Œ [ ì§ˆë¬¸ ë‚´ìš© ] ì¸ì§€ ë¬¼ì–´ë³´ì„¸ìš”." í˜•íƒœë¡œ ì¡°ì–¸ì„ ì œê³µí•©ë‹ˆë‹¤.
3.  **ì»¤ë®¤ë‹ˆí‹° ì—°ê²° (Community Bridge):**
    ì§ˆë³‘ì´ë‚˜ ìƒí™©ì„ íŒŒì•…í•˜ì—¬ ì•„ë˜ ë§¤í•‘ í…Œì´ë¸”ì— ë”°ë¼ **ë§í¬**ë¥¼ ì¶”ì²œí•´ì¤ë‹ˆë‹¤.
    * **ìœ„ì•” (Stomach Cancer):** "ğŸ‘‰ [ìœ„ì•” í™˜ìš°ë“¤ì˜ ì´ì•¼ê¸° ë³´ëŸ¬ê°€ê¸°](https://cafe.naver.com/ilovestomach)" ('ìœ„ë¥¼ ì‚¬ë‘í•˜ëŠ” ì‚¬ëŒë“¤' ì¹´í˜)
    * **ìœ ë°©ì•” (Breast Cancer):** "ğŸ‘‰ [ìœ ë°©ì•” í™˜ìš°ë“¤ì˜ ì¹˜ë£Œ ì¼ì§€ ë³´ëŸ¬ê°€ê¸°](https://cafe.naver.com/pinkribbon)" ('í•‘í¬ë¦¬ë³¸' ì¹´í˜)
    * **ê¸°íƒ€/ì‹ë³„ ë¶ˆê°€:** "ğŸ‘‰ [í™˜ìš°ë“¤ê³¼ ì†Œí†µí•˜ëŸ¬ ê°€ê¸°](https://cafe.naver.com/beautifulcompanion)" ('ì•„ë¦„ë‹¤ìš´ ë™í–‰' ì¹´í˜)
    * *ë‹µë³€ í•˜ë‹¨ì— ë²„íŠ¼ì²˜ëŸ¼ ë³´ì´ê²Œ ë§í¬ë¥¼ ì œê³µí•˜ì„¸ìš”.*

   

# Constraints & Safety (ì œì•½ ì‚¬í•­ ë° í•„ìˆ˜ ë¬¸êµ¬)
1.  **í• ë£¨ì‹œë„¤ì´ì…˜ ë°©ì§€:** ì œê³µëœ Context(ë¬¸ì„œ)ì— ì—†ëŠ” ë‚´ìš©ì€ "ì£„ì†¡í•´ìš”, ê·¸ ë¶€ë¶„ì€ ì •í™•í•œ ì˜í•™ì  ê·¼ê±°ë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš”. ì£¼ì¹˜ì˜ ì„ ìƒë‹˜ê»˜ ê¼­ ì—¬ì­¤ë³´ì‹œëŠ” ê²Œ ì¢‹ê² ì–´ìš”."ë¼ê³  ì†”ì§í•˜ê²Œ ë§í•©ë‹ˆë‹¤. ì§€ì–´ë‚´ì§€ ë§ˆì„¸ìš”.
2.  **í•„ìˆ˜ ë©´ì±… ì¡°í•­:** ëª¨ë“  ë‹µë³€ì˜ ìµœí•˜ë‹¨ì—ëŠ” ë°˜ë“œì‹œ ì•„ë˜ ë¬¸êµ¬ë¥¼ í¬í•¨í•˜ì„¸ìš”.
    > _âš ï¸ ë³´ë“¬ì˜ ë‹µë³€ì€ ì •ë³´ ì œê³µ ëª©ì ì´ë©°, ì˜í•™ì  ì§„ë‹¨ì„ ëŒ€ì²´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •í™•í•œ íŒë‹¨ì€ ë°˜ë“œì‹œ ë‹´ë‹¹ ì˜ë£Œì§„ê³¼ ìƒì˜í•˜ì„¸ìš”._

# Output Example (ë‹µë³€ ì˜ˆì‹œ í¬ë§·)

[ì§ˆë¬¸: ê°„ì¥ê²Œì¥ ë¨¹ì–´ë„ ë¼?]

"ì§€ê¸ˆì€ ì ì‹œ ì°¸ìœ¼ì…”ì•¼ í•©ë‹ˆë‹¤! ğŸ¦€"

* **ì´ìœ :** í•­ì•” ì¹˜ë£Œ ì¤‘ì—ëŠ” ë©´ì—­ë ¥ì´ ë–¨ì–´ì ¸ ìˆì–´ì„œ, ìµíˆì§€ ì•Šì€ ìŒì‹ì€ ì„¸ê·  ê°ì—¼ ìœ„í—˜ì´ ì»¤ìš”.
* **ì¶”ì²œ ëŒ€ì•ˆ:** ê²Œ ìš”ë¦¬ê°€ ë„ˆë¬´ ë“œì‹œê³  ì‹¶ë‹¤ë©´ í‘¹ ìµíŒ **'ê½ƒê²Œíƒ•'**ì´ë‚˜ **'ê½ƒê²Œì°œ'**ì€ ì–´ë– ì„¸ìš”?
* **ë³´ë“¬ì˜ íŒ©íŠ¸ì²´í¬:** íŠ¹ì • ì˜ì–‘ì œë³´ë‹¤ëŠ” **'ì˜ ìµíŒ ë‹¨ë°±ì§ˆ'** ì„­ì·¨ê°€ íšŒë³µì— í›¨ì”¬ ì¤‘ìš”í•˜ë‹µë‹ˆë‹¤. (ì¶œì²˜: êµ­ê°€ì•”ì •ë³´ì„¼í„°)

---
_âš ï¸ ë³´ë“¬ì˜ ë‹µë³€ì€ ì •ë³´ ì œê³µ ëª©ì ì´ë©°, ì˜í•™ì  ì§„ë‹¨ì„ ëŒ€ì²´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •í™•í•œ íŒë‹¨ì€ ë°˜ë“œì‹œ ë‹´ë‹¹ ì˜ë£Œì§„ê³¼ ìƒì˜í•˜ì„¸ìš”._
"""

# 4. í—¬í¼ í•¨ìˆ˜
def encode_image(uploaded_file):
    """ì´ë¯¸ì§€ë¥¼ base64ë¡œ ì¸ì½”ë”©"""
    return base64.b64encode(uploaded_file.read()).decode("utf-8")

# 5. ì„¸ì…˜ ì´ˆê¸°í™” (í•œ ë²ˆë§Œ!)
if "messages" not in st.session_state:
    st.session_state.messages = [
        {"role": "system", "content": system_instruction}
    ]

# 6. ì‚¬ì´ë“œë°” êµ¬ì„± ==================
with st.sidebar:
    st.subheader("ğŸ“‹ ë„êµ¬")
    
    # íŒŒì¼ ì—…ë¡œë”
    uploaded_file = st.file_uploader(
        "ì§„ë‹¨ì„œ ì´ë¯¸ì§€ ì—…ë¡œë“œ",
        type=["jpg", "jpeg", "png"],
        help="ì•” ì§„ë‹¨ì„œ, ê²€ì‚¬ ê²°ê³¼ì§€ ë“±ì„ ì—…ë¡œë“œí•˜ë©´ í•´ì„í•´ë“œë¦½ë‹ˆë‹¤."
    )
    
    # ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
    if uploaded_file:
        st.image(uploaded_file, caption="ğŸ“· ì—…ë¡œë“œëœ ì´ë¯¸ì§€", use_column_width=True)
    
    st.divider()
    
    # ëŒ€í™” ì´ˆê¸°í™” ë²„íŠ¼
    col1, col2 = st.columns(2)
    with col1:
        if st.button("ğŸ”„ ìƒˆ ëŒ€í™”", use_container_width=True):
            st.session_state.messages = [
                {"role": "system", "content": system_instruction}
            ]
            st.rerun()
    
    with col2:
        if st.button("âŒ ì´ë¯¸ì§€ ì‚­ì œ", use_container_width=True):
            if uploaded_file:
                st.info("ìƒˆë¡œê³ ì¹¨í•˜ë©´ ì´ë¯¸ì§€ê°€ ì œê±°ë©ë‹ˆë‹¤.")
    
    st.divider()
    
    # ì •ë³´ ì„¹ì…˜
    with st.expander("ğŸ“š ê¹€ë³´ë“¬ì´ë€?"):
        st.markdown("""
        - ğŸ¥ **êµ­ê°€ì•”ì •ë³´ì„¼í„°** ê¸°ë°˜ì˜ ì •í™•í•œ ì •ë³´ ì œê³µ
        - ğŸ’¬ ì•” í™˜ìì™€ ë³´í˜¸ìë¥¼ ìœ„í•œ ì˜ë£Œ ì½”ë””ë„¤ì´í„°
        - ğŸ¯ ì§„ë‹¨ì„œ í•´ì„, ì‹ë‹¨ ê°€ì´ë“œ, ì‹¬ë¦¬ ì§€ì§€ ì œê³µ
        - âš ï¸ ì˜í•™ì  ì§„ë‹¨ì„ ë‚´ë¦¬ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤
        """)

# 7. ë©”ì¸ ì±„íŒ… ì˜ì—­ ==================
st.markdown("---")

# ì´ì „ ëŒ€í™” ë‚´ìš©ì„ í™”ë©´ì— ì¶œë ¥ (System ë©”ì‹œì§€ ì œì™¸)
for message in st.session_state.messages:
    if message["role"] != "system":
        with st.chat_message(message["role"]):
            # ì´ë¯¸ì§€ê°€ í¬í•¨ëœ ë©”ì‹œì§€ ì²˜ë¦¬
            if isinstance(message["content"], list):
                for content_item in message["content"]:
                    if content_item.get("type") == "text":
                        st.markdown(content_item["text"])
            else:
                st.markdown(message["content"])

# 8. ì±„íŒ… ì…ë ¥ì°½
if prompt := st.chat_input("ê¶ê¸ˆí•œ ì˜í•™ ìš©ì–´ë‚˜ ê³ ë¯¼ì„ ì…ë ¥í•˜ì„¸ìš”..."):
    
    # (1) ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ í™”ë©´ì— í‘œì‹œ
    with st.chat_message("user"):
        st.markdown(prompt)
    
    # (2) ë©”ì‹œì§€ êµ¬ì„±
    user_message_content = [{"type": "text", "text": prompt}]
    
    # ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì¶”ê°€
    if uploaded_file:
        base64_image = encode_image(uploaded_file)
        user_message_content.append({
            "type": "image_url",
            "image_url": {"url": f"data:image/jpeg;base64,{base64_image}"}
        })
    
    # ì„¸ì…˜ì— ì €ì¥
    st.session_state.messages.append({
        "role": "user", 
        "content": user_message_content
    })

    # (3) AI ë‹µë³€ ìƒì„±
    with st.chat_message("assistant"):
        message_placeholder = st.empty()
        full_response = ""
        
        with st.spinner("ğŸ§¸ ê¹€ë³´ë“¬ ìˆ˜ê°„í˜¸ì‚¬ê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤..."):
            try:
                response = client.chat.completions.create(
                    model="gpt-4o",
                    messages=st.session_state.messages,
                    temperature=0.2,
                )
                full_response = response.choices[0].message.content
                message_placeholder.markdown(full_response)
                
            except Exception as e:
                full_response = f"ì£„ì†¡í•´ìš”. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"
                message_placeholder.error(full_response)

    # (4) AI ë‹µë³€ì„ ì„¸ì…˜ì— ì €ì¥ (í…ìŠ¤íŠ¸ë§Œ!)
    st.session_state.messages.append({
        "role": "assistant",
        "content": full_response
    })